{% extends "administa/base_admin.html" %}
{% load static %}

{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <div class="bg-white rounded-xl shadow-sm border border-gray-100">
    <div class="px-6 py-4 border-b border-gray-200">
      <h1 class="text-2xl font-bold text-gray-900">{{ title }}</h1>
    </div>
    
    <div class="p-6">
      <form method="post" enctype="multipart/form-data" class="space-y-8" id="photoForm">
        {% csrf_token %}
        
        <div class="space-y-2">
          <label for="photoTitle" class="block text-sm font-semibold text-gray-700">Titre *</label>
          <input type="text" name="title" id="photoTitle" value="{{ form.title.value|default:'' }}" required
                 class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200">
        </div>
        
        <div class="space-y-2">
          <label for="photoDescription" class="block text-sm font-semibold text-gray-700">Description</label>
          <textarea name="description" id="photoDescription" rows="4" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all duration-200">{{ form.description.value|default:'' }}</textarea>
        </div>
        
        <div class="space-y-2">
          <label for="photoFileInput" class="block text-sm font-semibold text-gray-700">Fichier image *</label>
          <input type="file" name="image" id="photoFileInput" class="w-full" accept="image/*" required>
        </div>
        
        <!-- Actions -->
        <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
          <a href="{% url 'admin_photos' %}" class="px-6 py-3 border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-50 transition-colors duration-200">
            Annuler
          </a>
          <button type="button" id="uploadButton" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 border border-transparent rounded-lg text-sm font-semibold text-white hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200">
            Enregistrer
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class DirectUploader {
    constructor(options) {
        this.options = options;
        this.file = null;
        this.startTime = null;

        // Bind methods
        this.handleFileSelect = this.handleFileSelect.bind(this);
        this.startUpload = this.startUpload.bind(this);

        // Initialize UI elements
        this.ui = {
            fileInput: document.getElementById(options.fileInputId),
            uploadButton: document.getElementById(options.uploadButtonId),
            overlay: document.getElementById('uploadOverlay'),
            title: document.getElementById('uploadTitle'),
            status: document.getElementById('uploadStatus'),
            percentage: document.getElementById('uploadPercentage'),
            progressBar: document.getElementById('uploadProgressBar'),
            speed: document.getElementById('uploadSpeed'),
            time: document.getElementById('uploadTime'),
            details: document.getElementById('uploadDetails'),
            successMessage: document.getElementById('uploadSuccessMessage'),
            errorMessage: document.getElementById('uploadErrorMessage'),
            errorText: document.getElementById('uploadErrorText'),
        };

        this.init();
    }

    init() {
        this.ui.fileInput.addEventListener('change', this.handleFileSelect);
        this.ui.uploadButton.addEventListener('click', this.startUpload);
    }

    handleFileSelect(e) {
        this.file = e.target.files[0];
        if (!this.file) {
            this.showError('Veuillez sélectionner un fichier.');
        }
    }

    showModal(title) {
        this.ui.title.textContent = title;
        this.ui.overlay.style.display = 'flex';
        this.ui.successMessage.style.display = 'none';
        this.ui.errorMessage.style.display = 'none';
        this.updateProgress(0, 0, 0);
    }

    hideModal() {
        this.ui.overlay.style.display = 'none';
    }

    showError(message) {
        this.ui.status.textContent = 'Erreur';
        this.ui.errorText.textContent = message;
        this.ui.errorMessage.style.display = 'block';
        this.ui.successMessage.style.display = 'none';
        // Keep modal open for 5 seconds on error
        setTimeout(() => this.hideModal(), 5000);
    }

    showSuccessAndRedirect(redirectUrl) {
        this.ui.status.textContent = 'Terminé !';
        this.ui.successMessage.style.display = 'block';
        this.ui.errorMessage.style.display = 'none';
        setTimeout(() => {
            window.location.href = redirectUrl;
        }, 2000);
    }

    updateProgress(loaded, total, elapsed) {
        if (total === 0) {
            this.ui.percentage.textContent = '0%';
            this.ui.progressBar.style.width = '0%';
            return;
        }

        const percent = Math.round((loaded / total) * 100);
        const speed = loaded / (1024 * 1024) / elapsed; // MB/s
        const remainingBytes = total - loaded;
        const remainingTime = (remainingBytes / (speed * 1024 * 1024));

        this.ui.percentage.textContent = `${percent}%`;
        this.ui.progressBar.style.width = `${percent}%`;
        this.ui.speed.textContent = `${speed.toFixed(2)} MB/s`;
        this.ui.details.textContent = `${(loaded / 1024 / 1024).toFixed(2)} / ${(total / 1024 / 1024).toFixed(2)} MB`;
        
        if (isFinite(remainingTime) && remainingTime > 0) {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = Math.floor(remainingTime % 60);
            this.ui.time.textContent = `${minutes}m ${seconds}s restantes`;
        } else {
            this.ui.time.textContent = '--';
        }
    }

    async startUpload() {
        if (!this.file) {
            alert('Veuillez sélectionner un fichier à uploader.');
            return;
        }

        this.showModal(`Upload de ${this.options.contentType}...`);

        try {
            // 1. Get Presigned URL
            this.ui.status.textContent = 'Préparation de l\'upload...';
            const presignedUrlResponse = await fetch(`/api/generate-presigned-url/?filename=${encodeURIComponent(this.file.name)}&type=${this.options.contentType.toLowerCase()}`);
            if (!presignedUrlResponse.ok) throw new Error('Impossible de générer l\'URL de téléversement.');
            const presignedData = await presignedUrlResponse.json();

            // 2. Upload to R2
            this.ui.status.textContent = 'Téléversement en cours...';
            await this.uploadFile(presignedData.presigned_url);

            // 3. Save Metadata
            this.ui.status.textContent = 'Enregistrement des informations...';
            const metadata = this.options.getMetadata();
            metadata.file_key = presignedData.file_key;
            metadata.public_url = presignedData.public_url;

            const metadataResponse = await fetch(this.options.metadataUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(metadata)
            });

            if (!metadataResponse.ok) throw new Error('Impossible d\'enregistrer les métadonnées.');
            
            this.showSuccessAndRedirect(this.options.redirectUrl);

        } catch (error) {
            console.error('Upload failed:', error);
            this.showError(error.message);
        }
    }

    uploadFile(url) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('PUT', url, true);
            xhr.setRequestHeader('Content-Type', this.file.type);
            this.startTime = Date.now();

            xhr.upload.onprogress = (event) => {
                if (event.lengthComputable) {
                    const elapsed = (Date.now() - this.startTime) / 1000;
                    this.updateProgress(event.loaded, event.total, elapsed);
                }
            };

            xhr.onload = () => {
                if (xhr.status === 200) {
                    resolve();
                } else {
                    reject(new Error(`L'upload a échoué avec le statut ${xhr.status}`));
                }
            };

            xhr.onerror = () => reject(new Error('Erreur réseau pendant l\'upload.'));
            xhr.onabort = () => reject(new Error('Upload annulé.'));

            xhr.send(this.file);
        });
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new DirectUploader({
        fileInputId: 'photoFileInput',
        uploadButtonId: 'uploadButton',
        contentType: 'Photo',
        metadataUrl: '/api/save-photo-metadata/',
        redirectUrl: '{% url "admin_photos" %}',
        getMetadata: () => {
            return {
                title: document.getElementById('photoTitle').value,
                description: document.getElementById('photoDescription').value,
            };
        }
    });
});
</script>
{% endblock %}